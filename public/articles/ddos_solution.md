---
title: 从一次DDoS看如何防御此类攻击

abstract: DDoS缓解或许不再那么艰难

picture: none

category: 0

ai_generated: false

---

## 起因

近日，我的某个IPv4公网服务器被其他人攻击，屡次被拉进黑洞，峰值攻击流量达到90Gbps，几乎所有直接暴露端口的服务都停摆，仅有通过Cloudflare代理的API服务等安然无恙，而Minecraft服务器的连接问题亟待解决。

## 紧急处理

当IP被从黑洞拉出后不久，我紧急联系服务器提供商，对方指出：

- 服务器若需要屏蔽国外IP，需要等待运营商审批，并且单次审批必须是整个C段ip，时间也需要半年以上，并不实际
- 单独在firewalld，机房层屏蔽并没有起到效果，因为流量仅需到达路由层即可触发黑洞机制。

之后，服务器提供商方面紧急提供了一个新的IPv4备用同网段地址，由于对方流量并未瘫痪路由，更换地址即可避免被拉入黑洞，解决了最基本的ip访问问题。

但是，如何暴露给公众的同时不遭受第二轮新的攻击便成为了接下来的问题。

首先，让我们明确：

1. DDoS攻击是针对ip地址的，并且和服务器所运行的服务没有关系

2. 计算服务器的防御并未恢复，可以说一打就进黑洞

3. Cloudflare的防御非常及时，挡下了所有DDoS攻击

于是，我紧急将qoriginal.vip的dns解析转向了Cloudflare，并且使用proxy和`Zero Trust`服务代理了所有的https服务，先解决了游戏之外的问题。

## 接下来怎么办？

第二轮DDoS攻击接踵而至，攻击者明显表示短时间内不会停止，如何处理Minecraft Server的tcp连接成了需要关心的问题。

现在有两个方案：

A.使用备选ip连接进服务器，使用FRP将tcp端口暴露出去

B.使用多台国内小服务器（小水管）代理tcp连接并且转发到计算服务器的新ip

这两种方法都可以在不暴露源站的情况下让用户建立连接，但是鉴于frp是公共资源，并且不具有抗DDoS能力，明显只能采用B方案。

## 集群配置

首先，我选择了某服务器提供商，在那里购买了多台性能羸弱，但是在国内拥有稳定网络上下行的vps，之后使用nginx搭建了如下的tcp服务：

```
stream {
    upstream minecraft_backend {
    server *.*.*.*:25565;
}

server {
    listen 25565;
    proxy_pass minecraft_backend;
    proxy_timeout 1m;
    proxy_connect_timeout 1s;
}
```

前提是nginx服务器应当需要stream模块。

当代理成功之后，只需要将这些暴露出的端口以`SRV`解析方式解析到域名，根据优先级不同，客户端会自动寻找优先级最高的可连接proxy进入服务器。

此方法拥有以下优点：

- 不可追踪。用户所有的连接均直接和代理服务器建立。

- 损失极小。当今DDoS成本依然较高，达到90Gbps的攻击强度需要数千元，并且同时target的数量有限，而购买一个拥有防御的小节点仅需数十元每月。

同时，分布式节点还同时使得中国各地包括海外的用户都有了一个还不错的连接速度。

## 解决

IP更换，分布式集群上线，再加上Cloudflare免费的服务，目前为止服务器已经恢复正常运行，并且可以保证一贯的连接速度和API稳定性。

后续我们还会对API等分布式进行下一步优化，努力做到单点失效不带来业务问题，DDoS的影响控制在可控范围内。


